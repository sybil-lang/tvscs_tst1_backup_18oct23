<?php
//checkLoggedIn('dealer'); //check Logged-in or not
$CI=&get_instance();
//$bundle=$CI->session->getSessionData("previouslySeenEmail");
$CI->load->helper('report');

checkCustomerType('dealer');
$dealer_code=$CI->session->getProfileData("login");
?>
<html>
<head>
<script type="text/javascript">
function getMonthsDiff(date1,date2,roundUpFractionalMonths)
{
    //Months will be calculated between start and end dates.
    //Make sure start date is less than end date.
    //But remember if the difference should be negative.
    var startDate=date1;
    var endDate=date2;
    var inverse=false;
    if(date1>date2)
    {
        //startDate=date2;
       // endDate=date1;
        inverse=true;
		//alert("good");
	   return -1;
    }

return moment([endDate.getFullYear(), endDate.getMonth(), endDate.getDate()]).diff(moment([startDate.getFullYear(), startDate.getMonth(), startDate.getDate()]), 'months');


};
</script>
<style type="text/css">
.rn_Body{
min-height: 1400px !important;
}
</style>
</head>
<body>

		 <input type="hidden" name="hfFirstYear" id="hfFirstYear" value="<?php echo date("Y");?>" />
		<input type="hidden" name="hfSecondYear" id="hfSecondYear" value="<?php echo date("Y")+1;?>" />
		<input type="hidden" name="hfyear1" id="hfyear1" value="<?php echo date('d/m/Y', mktime(0,0,0,1,1,date("Y")));?>" />
		<input type="hidden" name="hfyear2" id="hfyear2" value="<?php echo date('d/m/Y');?>" />

		<script type="text/javascript">
		//$('#piechart2').highcharts({
var optionspdd_line;
var optionspdd_pie;
var optionspdd_bar;
	optionspdd_line = {
            chart: {
                zoomType: 'x',
				renderTo: 'pddcontainer',
                margin: 100,
            },
            title: {
                useHTML: true,
                text: '<a href="https://tvscs.custhelp.com/app/dealer/dealer_disbursal_detail" id="linktopdd">PDD PENDING In '+$("[id$=hfFirstYear]").val()+'</a>',
            },
            subtitle: {
                useHTML: true,
                text:'*Click above link to view the PDD performance*',
                style:{
                    color:'green',
                    fontSize: '14px',
                }
            },
            xAxis: {
              // categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
				type: "category",
                crosshair: false,
                tickLength: 5,
            },
            tooltip: {
                useHTML: true,
                enabled:true,
                shared:true,                
            },
            credits: {
                enabled: false
            },
            legend: {
                enabled: true,
                itemDistance:40,
                itemHiddenStyle: {
                    color: 'green'
                },
                itemHoverStyle: {
                    color: 'red'
                },
                labelFormatter: function () {
                    return this.name + '(click to hide)';
                }
            },
            plotOptions: {
                area: {
                    fillColor: 'rgba(2,160,233,.6)',
                    lineColor: 'rgba(42,148,184,1)',
                    marker: {
                        radius: 2,
                        fillColor: 'rgba(2,160,233,.8)',
                    },
                    lineWidth: 1,
                    states: {
                        hover: {
                            lineWidth: 1
                        }
                    },
                    threshold: null
                },
                series: {
                    dataLabels: { 
                        align: 'left',
                        enabled: false,
                    },
                },
            },
			series: [{}]
          
        };


		</script>
	</head>
	<body>
	
	<div class="col-sm-9 col-md-9 col-lg-12" id="contemt-main">
              
              <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4" id="">
									&nbsp;
                </div>
	<div class="col-xs-12 col-sm-12 col-md-6 col-lg-8">
                  <div class="row">
						<div class='col-sm-12 form-inline datetimepickerwrapper'>
								<select name="ddlyear" id="ddlyear_3" class=" btn btn-default">
										<?php
										for($i=date("Y");$i>=2008;$i--){
										?>
										<option value="<?php echo date($i);?>" <?php if($i == date("Y")) { echo "selected"; } ?> ><?php echo $i;?></option>
										<?php } ?>
									</select>
                    </div>
        </div>
</div></div>
<div class="clearfix"><p>&nbsp;</p></div>
<div class="row">
	<div class="col-sm-12">
		<div id="pddcontainer"></div>
	</div>
</div>
<div class="clearfix"><p>&nbsp;</p></div>

<div class="col-xs-12 col-sm-12 col-md-6 col-lg-8">
		  <div class="row">
			<div class='col-sm-12 form-inline datetimepickerwrapper'>
			  <div class="form-group">
				<label>From</label>
				<div class='input-group date' id='datetimepicker_6'>

				  <input type='text' class="form-control" value="<?php echo date('d/m/Y',mktime(0,0,0,date('m')-3,date('d'),date("Y")));?>" data-provide="datepicker"  />
				  <span class="input-group-addon click6">
								<span class="glyphicon glyphicon-calendar"></span>
				  </span>
				</div>
			  </div>

			  <div class="form-group">
				<label>To</label>
				<div class='input-group date' id='datetimepicker_7'>

				  <input type='text' class="form-control" value="<?php echo date('d/m/Y');?>" />
				  <span class="input-group-addon click7">
								<span class="glyphicon glyphicon-calendar"></span>
				  </span>
				</div>
			  </div>
			</div>
		  </div>

		</div>
	  </div>
	  <div class="clearfix"><p>&nbsp;</p></div>
	<div class="row">
		<div class="col-sm-6">
		  <div id="pddbarchart1"></div>
		</div>
		<div class="col-sm-6">
			<div id="pddpiechart1"></div>
		</div>
	</div>


</div>

<script type="text/javascript">
var pick_upstart_date = new Date(moment($('#datetimepicker_6 input').val(), 'DD/MM/YYYY', true).format());
var pick_upend_date = new Date(moment($('#datetimepicker_7 input').val(), 'DD/MM/YYYY', true).format());
var dealercode = '<?php echo $dealer_code;?>';
$(function() {
    //Maximum  date for which the analytic could be done
    var max_pickup_Date = new Date();
    var maxDate = new Date(new Date(max_pickup_Date).setMonth(max_pickup_Date.getMonth()-3));
    
	//alert(maxDate);
	//alert("good");
    $('#datetimepicker_6').datetimepicker({
      format:'DD/MM/YYYY'
      //maxDate : maxDate
    });
    //Setting the defailt date 
   // $('#datetimepicker_6').data("DateTimePicker").date(new Date('1 July 2016'));  
    
    $('#datetimepicker_7').datetimepicker({
      format:'DD/MM/YYYY'
    });
    
    $("#datetimepicker_6 input").click(function(){
        $(".click6").click();
    });

	$("#datetimepicker_7 input").click(function(){
        $(".click7").click();
    });
    
    //Variable initialization
    var static_sdate = new Date(moment($('#datetimepicker_6 input').val(), 'DD/MM/YYYY', true).format());
	//alert(static_sdate);
    
    //Checking for any change in the Date Time Picker input box to manipulate the chart data accordingly  
    $("#datetimepicker_6").on("dp.change", function(e) {
      
      $('#datetimepicker_6 input').blur();
     // $("#loader").removeClass("hidden");
      
      pick_upstart_date = new Date(moment(e.date, 'DD/MM/YYYY', true).format());
	  $('#datetimepicker_6').data("DateTimePicker").date(e.date);
      //var one_month_foward = new Date(new Date(pick_up_date).setMonth(pick_up_date.getMonth()+1)); 
      //$('#datetimepicker_7').data("DateTimePicker").date(one_month_foward);
      //pick_upstart_date  = new Date(moment(pick_upstart_date, 'DD/MM/YYYY', true).format());
	  //pick_upend_date  = new Date(moment(pick_upend_date, 'DD/MM/YYYY', true).format());
	//  alert(pick_upstart_date);
	 // alert(pick_upend_date);
	  var diff_mon = getMonthsDiff(pick_upstart_date,pick_upend_date);
	  //alert(diff_mon);
		if(diff_mon <=3  && diff_mon >= 0){
			 $("#loader").removeClass("hidden");
			 
			 updatechartData(pick_upstart_date,pick_upend_date,dealercode);
			  setTimeout(function(){
				//seed_data(pick_up_date,one_month_foward);  
				$("#loader").addClass("hidden");
			  },5000);
		  }else{
					bootbox.alert('<div class="alert alert-warning"><strong>Month Difference can not be greater then Three Months.</div>');
						
		  }
     
    });


	//Checking for any change in the Date Time Picker input box to manipulate the chart data accordingly  
    $("#datetimepicker_7").on("dp.change", function(e) {
      
      $('#datetimepicker_7 input').blur();
      $("#loader").removeClass("hidden");
      
      //var pick_upend_date = new Date(e.date);
	  pick_upend_date = new Date(moment(e.date, 'DD/MM/YYYY', true).format());
	  $('#datetimepicker_7').data("DateTimePicker").date(e.date);
      //var one_month_foward = new Date(new Date(pick_up_date).setMonth(pick_up_date.getMonth()+1)); 
      //$('#datetimepicker_7').data("DateTimePicker").date(one_month_foward);
      
     // alert(pick_upstart_date);
	 // alert(pick_upend_date);
	  var diff_mon = getMonthsDiff(pick_upstart_date,pick_upend_date);
	  //alert(diff_mon);
		if(diff_mon <=3  && diff_mon >= 0){
			 $("#loader").removeClass("hidden");
			 
			 updatechartData(pick_upstart_date,pick_upend_date,dealercode);
			  setTimeout(function(){
				//seed_data(pick_up_date,one_month_foward);  
				$("#loader").addClass("hidden");
			  },5000);
		  }else{
					bootbox.alert('<div class="alert alert-warning"><strong>Month Difference can not be greater then Three Months.</div>');
						
		  }
    });
});


	/**
 * Request data from the server, add it to the graph and set a timeout 
 * to request again
 */
	function requestPDDData(pick_up_date , one_month_foward) {
		var param = {
			'startDate' : pick_up_date,
			'endDate': one_month_foward,
			'dealerCode': '<?php echo $dealer_code;?>'
		};
		$.ajax({
			url: '/cc/DealerCustom/getPDDAgeingSummary',
			data: param,
			method: 'post',
			dataType: 'json',
			beforeSend: function() {
					$("#loader").removeClass("hidden");   
			},
			success: function(response) {
				//console.log(response);
				//alert(response[0].id);
				//console.log(response[0].data);
			optionspdd_line.series[0] = response[0];
			optionspdd_line.series[1] = response[1];
			optionspdd_line.series[2] = response[2];
			//	baroption.series[0] = response[0];
			//	baroption.series[1] = response[1];
				//console.log(options_line);
				var chart1 = new Highcharts.Chart(optionspdd_line);
		//		var chart = new Highcharts.Chart(baroption);
			
				
				$("#loader").addClass("hidden");   
			},
			cache: false
		});

		
}

function  updatechartData(startDate, endDate, dealerCode){
			
			var param = {
				'startDate': moment(startDate).format("DD/MM/YYYY"),
				'endDate': moment(endDate).format("DD/MM/YYYY"),
				'dealerCode':dealerCode
			}
			$.ajax({
					url: '/cc/DealerCustom/getPDDAgeingChartSummary',
					data: param,
					method: 'post',
					dataType: 'json',
					beforeSend: function() {
							$("#loader").removeClass("hidden");   
					},
					success: function(response) {
						//console.log(response);
						//alert(response[0].id);
						//console.log(response[0].data);
						//alert(response[0].data);
						if(response[0].data == null){
							/*optionspdd_pie.series[0].id = response[0].id;
							optionspdd_pie.series[0].colorByPoint = true;
							//optionspdd_pie.series[0].id = response[0].id;
							optionspdd_pie.series[0].data = '[{"name":"Invoice with Ageing","y":0,"count":0},{"name":"Insurance with Ageing","y":0,"count":0},{"name":"RC Book with Ageing","y":0,"count":0}]';*/
							bootbox.alert('<div class="alert alert-warning"><strong>No Data Found.</div>');
						}else{
							optionspdd_pie.series[0]= response[0];
						}

						if(response[1].data == null){
								/*optionspdd_bar.series[0].id = response[0].id;
								optionspdd_bar.series[0].color = response[0].color;
							//optionspdd_pie.series[0].id = response[0].id;
								optionspdd_bar.series[0].data = '[{"name":"Invoice with Ageing","y":0,"count":0},{"name":"Insurance with Ageing","y":0,"count":0},{"name":"RC Book with Ageing","y":0,"count":0}]';*/
//							bootbox.alert('<div class="alert alert-warning"><strong>No Data Found.</div>');
						}else{
							optionspdd_bar.series[0] = response[1];
						}
						var chart2 = new Highcharts.Chart(optionspdd_pie);
						var chart3 = new Highcharts.Chart(optionspdd_bar);

						$("#loader").addClass("hidden");   
					},
					cache: false
				});

   }

  //});
//});

		requestPDDData($("[id$=hfyear1]").val(),$("[id$=hfyear2]").val());
		updatechartData(pick_upstart_date,pick_upend_date,dealercode);
</script>


<script type="text/javascript">
optionspdd_bar = {
//$('#pddbarchart1').highcharts({
            chart: {
                type: 'column',
                margin: 75,
				renderTo: 'pddbarchart1',
                options3d: {
                    enabled: true,
                    alpha: 10,
                    beta: 15,
                    depth: 70
                }
            },
            title: {
                text: 'AGEING WISE SUMMARY'
            },

            plotOptions: {
                column: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    depth: 35,
                    dataLabels: {
                        enabled: true,
                        format: '{point.product}'
                    },
                    showInLegend: true,
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            tooltip: {
                shared: true,
                useHtml:true,
                pointFormat: 'COUNT :<b>{point.count}</b>',
                valueSuffix: ' ',
            },
            lang: {
                noData: "No Data Available"
            },
            legend:{
                align: 'center',
                itemHiddenStyle: {
                    color: 'green'
                },
                itemHoverStyle: {
                    color: 'red'
                },
                labelFormatter: function () {
                    return this.name + '(click to hide)';
                }
            },
            
            xAxis: {
               // categories: ['Invoice with Ageing','Insurance with Ageing','RC Book with Ageing']
			   type: 'category'
            },
            yAxis: {
                title: {
                    text: null
                }
            },
            credits: {
                enabled: false
            },
            series: [{}]
        };

//$('#pddpiechart1').highcharts({
optionspdd_pie = {
	chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
				renderTo: 'pddpiechart1',
                type: 'pie'
            },
            title: {
                text: 'Ageing wise Summary'
            },
            tooltip: {
                pointFormat: 'COUNT :<b>{point.count}</b> <br/> VALUE :<b> {point.y}</b>'
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: false
                    },
                    showInLegend: true
                }
            },
			credits: {
                enabled: false
            },
            series: [{}]
};

//requestDisbursalData
$('#ddlyear_3').on('change', function(){
		var selYear = $('#ddlyear_3').val();
		alert(selYear);
		var s_date = '01/01/'+selYear;
		var e_date = '31/12/'+selYear;
		requestPDDData(s_date,e_date);
});
</script>


</body>
</html>
